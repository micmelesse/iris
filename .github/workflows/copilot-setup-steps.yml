name: Copilot Setup Steps

on:
  workflow_dispatch:
  push:
    paths:
      - .github/workflows/copilot-setup-steps.yml
  pull_request:
    paths:
      - .github/workflows/copilot-setup-steps.yml

jobs:
  copilot-setup-steps:
    runs-on: [self-hosted, copilot]

    permissions:
      contents: read

    timeout-minutes: 59

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        
      - name: Create task venv for Copilot
        run: |
          python3 -m venv $GITHUB_WORKSPACE/.venv
          source $GITHUB_WORKSPACE/.venv/bin/activate
          python -m pip install --upgrade pip
          python -m pip install -e .

      - name: Make venv default for subsequent steps
        run: |
          echo "$GITHUB_WORKSPACE/.venv/bin" >> $GITHUB_PATH

      - name: Verify ROCm and GPU visibility
        run: |
          echo "=== rocminfo ==="
          rocminfo | head -50 || true
          echo "=== rocm-smi ==="
          rocm-smi || true

      - name: Install project in editable mode
        run: |
          pip install -e .
