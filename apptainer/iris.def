# SPDX-License-Identifier: MIT
# Copyright (c) 2025-2026 Advanced Micro Devices, Inc. All rights reserved.

Bootstrap: docker
From: rocm/pytorch:rocm7.1_ubuntu24.04_py3.13_pytorch_release_2.9.1

%post
    /bin/bash -c "
    # Set environment variables
    export TRITON_PATH=/opt/triton
    export ROCM_PATH=/opt/rocm
    export LD_LIBRARY_PATH=\$ROCM_PATH/lib:\$LD_LIBRARY_PATH
    export PATH=\"\$ROCM_PATH/bin:\$PATH\"

    # Install system packages
    apt-get update && \
    DEBIAN_FRONTEND=noninteractive apt-get install -y \
        git wget ninja-build cmake python3-pip python3-dev build-essential jq && \
    rm -rf /var/lib/apt/lists/*

    # Create groups if they don't exist
    groupadd -r video 2>/dev/null || true
    groupadd -r render 2>/dev/null || true

    # Install Python packages with pip
    pip3 install --upgrade pip && \
    pip3 install wheel jupyter

    # Clone and install Triton
    cd /opt
    git clone https://github.com/triton-lang/triton.git \$TRITON_PATH
    cd \$TRITON_PATH
    git checkout aafec417bded34db6308f5b3d6023daefae43905 
    pip3 install -e .
    "

%environment
    # Define environment variables
    export TRITON_PATH=/opt/triton
    export ROCM_PATH=/opt/rocm
    export PYTHONPATH=$TRITON_PATH
    export LD_LIBRARY_PATH=$ROCM_PATH/lib:$LD_LIBRARY_PATH
    export PATH="$ROCM_PATH/bin:$PATH"
    export OMPI_MCA_mtl="^ofi"
    export OMPI_MCA_pml="ob1"
    export OMPI_ALLOW_RUN_AS_ROOT_CONFIRM=1
    export OMPI_ALLOW_RUN_AS_ROOT=1

%runscript
    echo "Welcome to the ROCm-aware Apptainer image!"
    exec "$@"
